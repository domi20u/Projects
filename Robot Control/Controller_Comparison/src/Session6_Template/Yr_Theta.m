function [Yr,Theta] = Yr_Theta(Q,Qp,Qrp,Qrpp,m1,m2,m3,L1,L2,L3,L4,L5,L6,L7,L8,L9,L10,I,g,gx,gy,gz)

q1 = Q(1);
q2 = Q(2);
q3 = Q(3);
q1p = Qp(1);
q2p = Qp(2);
q3p = Qp(3);

q1rp = Qrp(1);
q2rp = Qrp(2);
q3rp = Qrp(3);
q1rpp = Qrpp(1);
q2rpp = Qrpp(2);
q3rpp = Qrpp(3);

I111=I(1);
I112=I(2);
I113=I(3);
I122=I(4);
I123=I(5);
I133=I(6);
I211=I(7);
I212=I(8);
I213=I(9);
I222=I(10);
I223=I(11);
I233=I(12);
I311=I(13);
I312=I(14);
I313=I(15);
I322=I(16);
I323=I(17);
I333=I(18);


Theta(1,1)=I133;
Theta(2,1)=I211;
Theta(3,1)=I222;
Theta(4,1)=I311;
Theta(5,1)=I312;
Theta(6,1)=L3^2*m3;
Theta(7,1)=L7^2*m2;
Theta(8,1)=L8^2*m2;
Theta(9,1)=L9^2*m3;
Theta(10,1)=L10^2*m3;
Theta(11,1)=I212;
Theta(12,1)=L3*L10*m3;
Theta(13,1)=I313;
Theta(14,1)=I323;
Theta(15,1)=I213;
Theta(16,1)=I223;
Theta(17,1)=L3*L9*m3;
Theta(18,1)=L7*L8*m2;
Theta(19,1)=L9*L10*m3;
Theta(20,1)=I233;
Theta(21,1)=I333;
Theta(22,1)=I322;
Theta(23,1)=g*gx*m3*L9;
Theta(24,1)=g*gx*m3*L3;
Theta(25,1)=g*gx*m3*L10;
Theta(26,1)=g*gy*m3*L3;
Theta(27,1)=g*gy*m3*L9;
Theta(28,1)=g*gy*m3*L10;
Theta(29,1)=g*gx*m2*L7;
Theta(30,1)=g*gx*m2*L8;
Theta(31,1)=g*gy*m2*L7;
Theta(32,1)=g*gy*m2*L8;
Theta(33,1)=g*gz*m3*L10;
Theta(34,1)=g*gz*m3*L3;
Theta(35,1)=g*gz*m2*L8;

% Define the matrix of states (symbolic form)
Yr(1:3,1)=[q1rpp;0;0];
Yr(1:3,2)=[(1+cos(2*q2))/2*q1rpp - sin(2*q2)/2*(q2p*q1rp+q1p*q2rp);
           sin(2*q2)/2*q1p*q1rp;
           0];
Yr(1:3,3)=[(1-cos(2*q2))/2*q1rpp + sin(2*q2)/2*(q2p*q1rp+q1p*q2rp);% + sin(2*q2+2*q3)/2*(pq2+pq3)*pq1r;       % It's weird that the indices do not rotate!
           -sin(2*q2)/2*q1p*q1rp;
           0];
Yr(1:3,4)=[(1+cos(2*q2+2*q3))/2*q1rpp - sin(2*q2+2*q3)/2*(q1p*q2rp+q2p*q1rp+q1p*q3rp+q3p*q1rp);
           sin(2*q2+2*q3)/2*q1p*q1rp;
           sin(2*q2+2*q3)/2*q1p*q1rp];
Yr(1:3,5)=[-sin(2*q2+2*q3)*q1rpp - cos(2*q2+2*q3)*((q2p+q3p)*q1rp+q1p*(q2rp+q3rp));
           cos(2*q2+2*q3)*q1p*q1rp;
           cos(2*q2+2*q3)*q1p*q1rp];
Yr(1:3,6)=[(1-cos(2*q2))/2*q1rpp + sin(2*q2)/2*(q2p*q1rp+q1p*q2rp);
           q2rpp - sin(2*q2)/2*q1p*q1rp;
           0];       
Yr(1:3,7)=[q1rpp;0;0]; 
Yr(1:3,8)=[(1-cos(2*q2))/2*q1rpp + sin(2*q2)/2*(q2p*q1rp+q1p*q2rp);
           q2rpp - sin(2*q2)/2*q1p*q1rp;
           0];
Yr(1:3,9)=[q1rpp;0;0]; 
Yr(1:3,10)=[(1-cos(2*q2+2*q3))/2*q1rpp + sin(2*q2+2*q3)/2*((q2p+q3p)*q1rp+q1p*(q2rp+q3rp));
            q2rpp + q3rpp - sin(2*q2+2*q3)/2*q1p*q1rp;
            q2rpp + q3rpp - sin(2*q2+2*q3)/2*q1p*q1rp]; 
Yr(1:3,11)=[-sin(2*q2)*q1rpp - cos(2*q2)*(q2p*q1rp+q1p*q2rp);
            cos(2*q2)*q1p*q1rp;
            0]; 
Yr(1:3,12)=[(cos(q3)-cos(2*q2+q3))*q1rpp - sin(q3)/2*(q3p*q1rp+q1p*q3rp) ...
              + sin(2*q2+q3)/2*(2*q1p*q2rp+2*q2p*q1rp+q1p*q3rp+q3p*q1rp);
            cos(q3)*(2*q2rpp+q3rpp) - sin(2*q2+q3)*q1p*q1rp - sin(q3)*(q3p*q2rp+(q2p+q3p)*q3rp);
            cos(q3)*q2rpp + (sin(q3)-sin(2*q2+q3))/2*q1p*q1rp + sin(q3)*q2p*q2rp]; 
Yr(1:3,13)=[cos(q2+q3)*(q2rpp+q3rpp) - sin(q2+q3)*(q2p+q3p)*(q2rp+q3rp);
            cos(q2+q3)*q1rpp;
            cos(q2+q3)*q1rpp];
Yr(1:3,14)=[-sin(q2+q3)*(q2rpp+q3rpp) - cos(q2+q3)*(q2p+q3p)*(q2rp+q3rp);
            -sin(q2+q3)*q1rpp;
            -sin(q2+q3)*q1rpp];
Yr(1:3,15)=[cos(q2)*q2rpp - sin(q2)*q2p*q2rp;
            cos(q2)*q1rpp;
            0];
Yr(1:3,16)=[-sin(q2)*q2rpp - cos(q2)*q2p*q2rp;
            -sin(q2)*q1rpp;
            0];
Yr(1:3,17)=[-cos(q2)*q2rpp + sin(q2)*q2p*q2rp;
            -cos(q2)*q1rpp;
            0];
Yr(1:3,18)=[-cos(q2)*q2rpp + sin(q2)*q2p*q2rp;
            -cos(q2)*q1rpp;
            0];
Yr(1:3,19)=[-cos(q2+q3)*(q2rpp+q3rpp) + sin(q2+q3)*(q2p+q3p)*(q2rp+q3rp);
            -cos(q2+q3)*q1rpp;
            -cos(q2+q3)*q1rpp];
Yr(1:3,20)=[0;q2rpp;0]; 
Yr(1:3,21)=[0;q2rpp+q3rpp;q2rpp+q3rpp]; 
Yr(1:3,22)=[(1-cos(2*q2+2*q3))/2*q1rpp + sin(2*q2+2*q3)/2*(q1p*q2rp+q2p*q1rp+q1p*q3rp+q3p*q1rp);
            -sin(2*q2+2*q3)/2*q1p*q1rp;
            -sin(2*q2+2*q3)/2*q1p*q1rp];
Yr(1:3,23)=[cos(q1);0;0]; 
Yr(1:3,24)=[sin(q1)*sin(q2);-cos(q1)*cos(q2);0]; 
Yr(1:3,25)=[sin(q1)*(cos(q2)*sin(q3)+sin(q2)*cos(q3));
            -cos(q1)*cos(q2+q3);
            -cos(q1)*(cos(q2)*cos(q3)-sin(q2)*sin(q3))];
Yr(1:3,26)=[-cos(q1)*sin(q2);-sin(q1)*cos(q2);0]; 
Yr(1:3,27)=[sin(q1);0;0]; 
Yr(1:3,28)=[-cos(q1)*(cos(q2)*sin(q3)+sin(q2)*cos(q3));
            -sin(q1)*cos(q2+q3);
            -sin(q1)*(cos(q2)*cos(q3)-sin(q2)*sin(q3))];
Yr(1:3,29)=[cos(q1);0;0]; 
Yr(1:3,30)=[sin(q1)*sin(q2);-cos(q1)*cos(q2);0]; 
Yr(1:3,31)=[sin(q1);0;0]; 
Yr(1:3,32)=[-cos(q1)*sin(q2);-sin(q1)*cos(q2);0]; 
Yr(1:3,33)=[0;-sin(q2+q3);-sin(q2+q3)];
Yr(1:3,34)=[0;-sin(q2);0]; 
Yr(1:3,35)=[0;-sin(q2);0];


end

